/*! jquery-indexeddb  v0.2.2 2013-04-03 */
(function(e){function n(e){var n=null;switch(e){case 0:case 1:case"readwrite":case"readonly":n=e;break;default:n=c.READ_WRITE||"readwrite"}return n}var t=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,o=window.IDBKeyRange||window.webkitIDBKeyRange,r=window.IDBCursor||window.webkitIDBCursor;r.PREV=r.PREV||"prev",r.NEXT=r.NEXT||"next";var c=window.IDBTransaction||window.webkitIDBTransaction;e.extend({indexedDB:function(r,c){if(c){"number"==typeof c&&(c={version:c});var i=c.version;if(c.schema&&!i){var u=-1;for(key in c.schema)u=u>key?u:key;i=c.version||u}}var a={request:function(n,t){return e.Deferred(function(e){try{var o="function"==typeof n?n(t):n;o.onsuccess=function(n){console.log("Success",o,n,this),e.resolveWith(o,[o.result,n])},o.onerror=function(n){console.log("Error",o,n,this),e.rejectWith(o,[o.error,n])},o.onblocked!==undefined&&null===o.onblocked&&(o.onblocked=function(n){console.log("Blocked",o,n,this);var t;try{t=o.result}catch(n){t=null}e.notifyWith(o,[t,n])}),o.onupgradeneeded!==undefined&&null===o.onupgradeneeded&&(o.onupgradeneeded=function(n){console.log("Upgrade",o,n,this),e.notifyWith(o,[o.result,n])})}catch(r){r.name="exception",e.rejectWith(o,["exception",r])}})},transaction:function(e){return{objectStore:function(n){try{return a.objectStore(e.objectStore(n))}catch(t){return e.readyState!==e.DONE&&e.abort(),a.objectStore(null)}},createObjectStore:function(n,t){try{return a.objectStore(e.db.createObjectStore(n,t))}catch(o){e.readyState!==e.DONE&&e.abort()}},deleteObjectStore:function(n){try{e.db.deleteObjectStore(n)}catch(t){e.readyState!==e.DONE&&e.abort()}},abort:function(){e.abort()}}},objectStore:function(e){for(var n={},t=["add","put","get","delete","clear","count"],o=0;t.length>o;o++)n[t[o]]=function(n){return function(){return a.request(function(t){return e[n].apply(e,t)},arguments)}}(t[o]);return n.each=function(n,t,o){return a.cursor(function(){return o?e.openCursor(a.range(t),o):e.openCursor(a.range(t))},n)},n.index=function(n){return a.index(function(){return e.index(n)})},n.createIndex=function(n,t,o){return 2===arguments.length&&"string"==typeof t&&(o=arguments[1],t=null),o||(o=n),a.index(function(){return e.createIndex(o,n,t)})},n.deleteIndex=function(n){return e.deleteIndex(n)},n},range:function(n){return e.isArray(n)?1===n.length?o.only(n[0]):o.bound(n[0],n[1],n[2]||!0,n[3]||!0):n===undefined?null:n},cursor:function(n,t){return e.Deferred(function(e){try{console.log("Cursor request created",n);var o="function"==typeof n?n():n;o.onsuccess=function(n){if(console.log("Cursor successful"),!o.result)return e.resolveWith(o,[null,n]),undefined;var r={"delete":function(){return a.request(function(){return o.result["delete"]()})},update:function(e){return a.request(function(){return o.result.update(e)})},next:function(e){this.data=e},key:o.result.key,value:o.result.value};console.log("Cursor in progress",r,n),e.notifyWith(o,[r,n]);var c=t.apply(o,[r]);console.log("Iteration function returned",c);try{c===!1?e.resolveWith(o,[null,n]):"number"==typeof c?o.result.advance.apply(o.result,[c]):r.data?o.result["continue"].apply(o.result,[r.data]):o.result["continue"]()}catch(n){console.log("Exception when trying to advance cursor",o,n),e.rejectWith(o,[o.result,n])}},o.onerror=function(n){console.log("Cursor request errored out",n),e.rejectWith(o,[o.result,n])}}catch(r){console.log("An exception occured inside cursor",o,r),r.type="exception",e.rejectWith(o,[null,r])}})},index:function(e){try{var n="function"==typeof e?e():e}catch(t){n=null}return console.log(n,e),{each:function(e,t,o){return a.cursor(function(){return o?n.openCursor(a.range(t),o):n.openCursor(a.range(t))},e)},eachKey:function(e,t,o){return a.cursor(function(){return o?n.openKeyCursor(a.range(t),o):n.openKeyCursor(a.range(t))},e)},get:function(e){return"function"==typeof n.get?a.request(n.get(e)):n.openCursor(a.range(e))},getKey:function(e){return"function"==typeof n.getKey?a.request(n.getKey(e)):n.openKeyCursor(a.range(e))}}}},s=a.request(function(){return console.log("Trying to open DB with",i),i?t.open(r,parseInt(i)):t.open(r)});return s.then(function(e){console.log("DB opened at",e.version),e.onversionchange=function(){c&&c.onversionchange&&c.onversionchange()!==!1||e.close()}},function(e,n){console.log(e,n)},function(e,n){if(n&&"upgradeneeded"===n.type){if(c&&c.schema){console.log("Upgrading DB to ",e.version);for(var t=n.oldVersion+1;n.newVersion>=t;t++)"function"==typeof c.schema[t]&&c.schema[t].call(this,a.transaction(this.transaction))}c&&"function"==typeof c.upgrade&&c.upgrade.call(this,a.transaction(this.transaction))}}),e.extend(s,{cmp:function(e,n){return t.cmp(e,n)},deleteDatabase:function(){return e.Deferred(function(e){s.then(function(n){n.close(),a.request(function(){return t.deleteDatabase(r)}).then(function(n,t){e.resolveWith(this,[n,t])},function(n,t){e.rejectWith(this,[n,t])},function(n,t){e.notifyWith(this,[n,t])})},function(n,t){e.rejectWith(this,[n,t])},function(n,t){e.notifyWith(this,[n,t])})})},transaction:function(t,o){return!e.isArray(t)&&(t=[t]),o=n(o),e.Deferred(function(e){s.then(function(n,r){var c;try{console.log("DB Opened, now trying to create a transaction",t,o),c=n.transaction(t,o),console.log("Created a transaction",c,o,t),c.onabort=c.onerror=function(n){e.rejectWith(c,[n])},c.oncomplete=function(n){e.resolveWith(c,[n])}}catch(r){return console.log("Creating a traction failed",r,t,o,this),r.type="exception",e.rejectWith(this,[r]),undefined}try{e.notifyWith(c,[a.transaction(c)])}catch(r){r.type="exception",e.rejectWith(this,[r])}},function(n,t){e.rejectWith(this,[t,n])},function(e,n){console.log("Database open is blocked or upgrade needed",e,n.type)})})},objectStore:function(o,i){function u(u){return e.Deferred(function(e){function l(n,t){try{console.log("Finally, returning the object store",n),t(n.objectStore(o)).then(function(n,t){e.resolveWith(this,[n,t])},function(n,t){e.rejectWith(this,[n,t])})}catch(r){console.log("Duh, an exception occured",r),r.name="exception",e.rejectWith(n,[r,r])}}d.transaction(o,n(i)).then(function(){console.log("Transaction completed")},function(f,h){if(f.code!==f.NOT_FOUND_ERR||i!==!0&&"object"!=typeof i)e.rejectWith(this,[f,h]);else{console.log("Object Not found, so will try to create one now");var g=this.result;g.close(),s=a.request(function(){return console.log("Now trying to open the database again",g.version),t.open(r,(parseInt(g.version,10)||1)+1)}),s.then(function(t){console.log("Database opened, tto open transaction",t.version),t.onversionchange=function(){c&&c.onversionchange&&c.onversionchange()!==!1||t.close()},d.transaction(o,n(i)).then(function(){console.log("Transaction completed when trying to create object store")},function(n,t){e.rejectWith(this,[n,t])},function(e,n){console.log("Transaction in progress, when object store was not found",this,e,n),l(e,u)})},function(n,t){e.rejectWith(this,[n,t])},function(n,t){if("upgradeneeded"===t.type)try{console.log("Now trying to create an object store",t.type),n.createObjectStore(o,i===!0?{autoIncrement:!0}:i),console.log("Object store created",o,n)}catch(r){console.log("Exception when trying ot create a new object store",r),e.rejectWith(this,[r,t])}})}},function(e){console.log("Transaction is in progress",e),l(e,u)})})}function l(e,n){return u(function(t){return t[e].apply(t,n)})}function f(e,n,t){return u(function(o){var r=o.index(n);return r[e].apply(r[e],t)})}for(var d=this,h={},g=["add","delete","get","put","clear","count","each"],p=0;g.length>p;p++)h[g[p]]=function(e){return function(){return l(e,arguments)}}(g[p]);return h.index=function(e){return{each:function(n,t,o){return f("each",e,[n,t,o])},eachKey:function(n,t,o){return f("eachKey",e,[n,t,o])},get:function(n){return f("get",e,[n])},getKey:function(n){return f("getKey",e,[n])}}},h}})}}),e.indexedDB.IDBCursor=r,e.indexedDB.IDBTransaction=c,e.idb=e.indexedDB})(jQuery);